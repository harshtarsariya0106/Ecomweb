{% extends 'shop/basic.html' %}
{% load static %}

{% block title %}Checkout - Cartify{% endblock %}

{% block body %}
<div class="container my-5">
    <h2 class="fw-bold mb-4">Checkout</h2>

    {% if items %}
    <div class="row">

        <!-- LEFT: SHIPPING FORM -->
        <div class="col-md-7">
            <form id="checkoutForm">
                {% csrf_token %}
                <input type="hidden" name="amount" value="{{ total }}">

                <input class="form-control mb-3" name="name" placeholder="Full Name" required>
                <input class="form-control mb-3" name="email" placeholder="Email" required>
                <input class="form-control mb-3" name="phone" placeholder="Phone" required>
                <input class="form-control mb-3" name="city" placeholder="City" required>
                <input class="form-control mb-3" name="state" placeholder="State" required>
                <input class="form-control mb-3" name="zip_code" placeholder="Zip Code" required>
                <textarea class="form-control mb-3" name="address" placeholder="Address" required></textarea>

                <button type="submit" class="btn btn-success w-100">
                    Pay & Place Order
                </button>
            </form>
        </div>

        <!-- RIGHT: ORDER SUMMARY -->
        <div class="col-md-5">
            <div class="card shadow-sm p-3">
                <h5 class="mb-3">Order Summary</h5>

                <ul class="list-group mb-3" id="cartList">
                    {% for item in items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center"
                        id="row-{{ item.product.product_id }}">
                        <span>{{ item.product.product_name }} Ã— {{ item.quantity }}</span>
                        <div class="d-flex align-items-center gap-2">
                            <strong>â‚¹{{ item.subtotal }}</strong>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="removeItem('{{ item.product.product_id }}')">
                                Remove
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>

                <h5 class="fw-bold text-end">
                    Total: â‚¹ <span id="cart-total">{{ total }}</span>
                </h5>
            </div>
        </div>

    </div>
    {% else %}
        <a href="/shop" style="text-decoration:none;">
            <div class="alert alert-warning text-center" style="cursor:pointer;">
                Your cart is empty â€” click here to continue shopping
            </div>
        </a>
    {% endif %}
</div>
{% endblock %}

{% block js %}
<!-- Razorpay SDK -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
console.log("Checkout JS loaded");

/* ================= CSRF TOKEN ================= */
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

/* ================= REMOVE ITEM ================= */
function removeItem(productId) {
    fetch("{% url 'remove_from_cart' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ product_id: productId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            const row = document.getElementById(`row-${productId}`);
            if (row) row.remove();

            if (document.querySelectorAll("#cartList li").length === 0) {
                window.location.reload();
            }
        }
    });
}

/* ================= CHECKOUT + RAZORPAY ================= */
document.addEventListener("DOMContentLoaded", function () {
    const checkoutForm = document.getElementById("checkoutForm");
    if (!checkoutForm) return;

    checkoutForm.addEventListener("submit", function (e) {
        e.preventDefault();

        // Send form data to backend to create Razorpay order
        fetch("{% url 'checkout' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: new FormData(checkoutForm)
        })
        .then(res => res.json())
        .then(data => {
            if (!data.razorpay_key || !data.razorpay_order_id) {
                alert("Payment initialization failed");
                return;
            }

            var options = {
                key: data.razorpay_key,
                amount: data.amount,
                currency: "INR",
                name: "Cartify",
                description: "Order Payment",
                order_id: data.razorpay_order_id,

                handler: function (response) {
                    // Mark payment success
                    fetch("{% url 'payment_success' %}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                            "X-CSRFToken": csrftoken
                        },
                        body: `razorpay_payment_id=${response.razorpay_payment_id}&razorpay_order_id=${response.razorpay_order_id}&order_id=${data.razorpay_order_id}`
                    })
                    .then(res => res.json())
                    .then(resData => {
                        if(resData.status === "success"){
                            // Clear cart session
                            fetch("{% url 'clear_cart' %}", {
                                method: "POST",
                                headers: { "X-CSRFToken": csrftoken }
                            }).then(() => {
                                alert("Payment Successful ðŸŽ‰");
                                window.location.href = "/shop";
                            });
                        }
                    });
                },

                theme: { color: "#198754" }
            };

            var rzp = new Razorpay(options);
            rzp.open();
        })
        .catch(err => console.error("Payment error:", err));
    });
});
</script>
{% endblock %}
